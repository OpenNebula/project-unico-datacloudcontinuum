# Description

This repository contains a tool to automatically deploy OpenNebula control plane on a bare metal host, adding the needed integrations required in the DATACLOUDCONTINUUM project to optimize the use of resources by using AI techniques.

Currently this repository deploys an OpenNebula installation with

- [Prometheus](https://prometheus.io/)
- [Scaphandre](https://hubblo-org.github.io/scaphandre-documentation/index.html) (energy consumption metrics)
- [OneKE](https://github.com/OpenNebula/one-apps/wiki/oneke_intro)

TODO: Add AIOps

## How to use

The installation process consists of two steps. The first step installs opennebula using [one-deploy](https://github.com/OpenNebula/one-deploy) the second step sets up [OneKE](https://github.com/OpenNebula/one-apps/wiki/oneke_intro) using the [terraform-opennebula](https://registry.terraform.io/providers/OpenNebula/opennebula/latest/docs) provider.

### Requirements

**Hardware**

- 1 bare metal server with at least:
  - 1 CPU 8 cores
  - 64 GB RAM
  - 500GB Hard disk
  - Internet connectivity

**Software**

- [ansible](https://github.com/OpenNebula/one-deploy/wiki/sys_reqs#requirements)
- terraform
- GNU make

### Installation

Clone this repository in the bare metal resource.

Some input is needed in order to bootstrap a minimal opennebula. At least a host where opennebula will be provisioned and the `oneadmin` user password. For this, create a `Makefile.local` file and enter the following information.

```bash
ONE_HOST = ip_address/hostname # where opennebula will be installed
ONE_PASSWORD = password # autogenerated if not provided
```

Then run

```bash
make dcc
```

You should now have a frontend that is able to [deploy OneKE clusters](https://github.com/OpenNebula/one-apps/wiki/oneke_deploy#downloading-and-deploying) based on the [oneflow service template](https://docs.opennebula.io/6.10/management_and_operations/multivm_service_management/appflow_use_cli.html#what-is-a-service) that the automation prepared. To actually deploy the Kubernetes clusters, you'll need KVM nodes. The frontend host is added as a baseline KVM node with host ID 0.

> [!TIP]
You can customize other parameters, like the **one-deploy** inventory file. Please take a look at `Makefile.config` to check the possible customizations.

### Post Installation

Once deployed, hypervisor nodes and VM networking can be added with [oneprovision](https://docs.opennebula.io/6.10/provision_clusters/edge_clusters/overview.html). You can setup scaphandre in these nodes with ansible by creating an inventory like this

```yaml
node:
  hosts:
    n1: { ansible_host: 10.0.1.8  } # replace the IP with the node IP
    # n2: { ansible_host: 10.0.1.9  } # use multiple node entries if needed
```

and just running the scaphandre role in a playbook like this

```yaml
---

- name: Install scaphandre
  hosts: "{{ node_group | d('node') }}"
  roles:
    - role: scaphandre
      tags: [preinstall]
```
